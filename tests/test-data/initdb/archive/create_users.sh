#!/usr/bin/env bash

psql=( psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" )

file_env 'ARCHIVE_READ_USER'
file_env 'ARCHIVE_READ_USER_PASSWORD'

file_env 'ARCHIVE_WRITE_USER'
file_env 'ARCHIVE_WRITE_USER_PASSWORD'

"${psql[@]}" <<-EOSQL
	CREATE USER "$ARCHIVE_READ_USER" WITH PASSWORD '$ARCHIVE_READ_USER_PASSWORD';
	CREATE USER "$ARCHIVE_WRITE_USER" WITH PASSWORD '$ARCHIVE_WRITE_USER_PASSWORD';
	CREATE ROLE readers;
	CREATE ROLE writers;
	GRANT readers to "$ARCHIVE_READ_USER", "$ARCHIVE_WRITE_USER";
	GRANT writers to "$ARCHIVE_WRITE_USER";
	GRANT SELECT ON ALL TABLES IN SCHEMA public TO GROUP readers;
	GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO GROUP writers;
	GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO GROUP writers;
	GRANT USAGE, SELECT ON read_queue_groups_group_id_seq TO GROUP readers;
	GRANT USAGE, SELECT ON read_queue_item_id_seq TO GROUP readers;
	GRANT SELECT, INSERT, UPDATE, DELETE on read_queue_groups TO GROUP readers;
	GRANT SELECT, INSERT, UPDATE, DELETE on read_queue TO GROUP readers;
EOSQL
